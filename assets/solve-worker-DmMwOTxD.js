var B=Object.defineProperty;var D=(d,u,f)=>u in d?B(d,u,{enumerable:!0,configurable:!0,writable:!0,value:f}):d[u]=f;var a=(d,u,f)=>D(d,typeof u!="symbol"?u+"":u,f);(function(){"use strict";function d(e,t){if(e.empty)throw Error(`source-empty ${e.name}`);if(e.done)throw Error(`source-closed ${e.name}`);if(t.full)throw Error(`target-full ${e.name}`);const s=e.topColor;if(!t.empty&&s!==t.topColor)throw Error("invalid-color");const n=Math.min(e.topAmount,t.emptySpace),o=e.levels.slice(0,-n),i=Array(n).fill(s),r=[...t.levels,...i];return[new u(e.id,o),new u(t.id,r)]}class u{constructor(t,s=[]){this.id=t,this.levels=s}get name(){return String.fromCharCode(65+this.id)}get empty(){return this.levels.length===0}get full(){return this.levels.length>=4}get emptySpace(){return 4-this.levels.length}get done(){return this.levels.length===4&&this.levels[0]===this.levels[1]&&this.levels[1]===this.levels[2]&&this.levels[2]==this.levels[3]&&this.levels[3]>0}get topColor(){return this.levels.length?this.levels[this.levels.length-1]:null}get topAmount(){if(this.levels.length<=1)return this.levels.length;const t=this.topColor;let s=1;for(;s<this.levels.length;){if(this.levels[this.levels.length-1-s]!=t)return s;s+=1}return this.levels.length}get singleColor(){return this.topAmount===this.levels.length}accepts(t){return this.empty?4:this.full?0:this.topColor===t?this.emptySpace:0}add(t){if(this.full)throw Error(`tube-full ${this.name}`);return new u(this.id,[...this.levels,t])}}const f=()=>{};function I(e,t){return e!=e?t==t:e!==t||e!==null&&typeof e=="object"||typeof e=="function"}const p=[];function $(e,t=f){let s=null;const n=new Set;function o(h){if(I(e,h)&&(e=h,s)){const c=!p.length;for(const l of n)l[1](),p.push(l,e);if(c){for(let l=0;l<p.length;l+=2)p[l][0](p[l+1]);p.length=0}}}function i(h){o(h(e))}function r(h,c=f){const l=[h,c];return n.add(l),n.size===1&&(s=t(o,i)||f),h(e),()=>{n.delete(l),n.size===0&&s&&(s(),s=null)}}return{set:o,update:i,subscribe:r}}const S=19;class M{constructor(t,s){a(this,"cumulative");a(this,"tot");this.items=t,this.cumulative=[],this.tot=0;for(let n=0;n<t.length;n++)this.tot+=s[n],this.cumulative.push(this.tot)}randomItem(){const t=Math.random()*this.tot;for(let s=0;s<this.items.length;s++)if(this.cumulative[s]>t)return this.items[s];return this.items[this.items.length-1]}}function R(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if(!n.done&&!n.empty)for(let o=0;o<e.length;o++){const i=e[o];s!==o&&i.accepts(n.topColor)&&t.push({from:n.id,to:i.id})}}return t}function k(e){return e.map(t=>t.done||t.empty).reduce((t,s)=>t&&s,!0)}var y=(e=>(e[e.Playing=0]="Playing",e[e.Won=1]="Won",e[e.Lost=2]="Lost",e))(y||{});class g{constructor(t=[]){a(this,"status");a(this,"tubes");this.tubes=[];for(const[s,n]of t.entries())n instanceof u?this.tubes.push(n):this.tubes.push(new u(s,n));this.status=0,k(this.tubes)?this.status=1:this.possibleActions().length===0&&(this.status=2)}possibleActions(){return R(this.tubes)}get won(){return this.status===1}get lost(){return this.status===2}get ended(){return this.status!==0}get numClosed(){return this.tubes.filter(t=>t.done).length}historyEntry({from:t,to:s}){if(this.tubes[t].topColor!==this.tubes[s].topColor&&!this.tubes[s].empty)throw new Error("invalid-color");const n=this.tubes[t].topColor;return{fromIndex:t,toIndex:s,fromId:this.tubes[t].name,toId:this.tubes[s].name,color:n,amount:Math.min(this.tubes[t].topAmount,this.tubes[s].accepts(n))}}applyMove({from:t,to:s}){const[n,o]=d(this.tubes[t],this.tubes[s]),i=[...this.tubes];return i[t]=n,i[s]=o,new g(i)}add(t,s){const n=[...this.tubes];return n[s]=this.tubes[s].add(t),new g(n)}getHash(){return this.tubes.map(t=>t.levels.concat(t.full?[]:[0])).flat().map(t=>t.toString(36)).join("")}}function C(e){return e[Math.floor(Math.random()*e.length)]}function W(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}}function q(e){const t=Array(S).fill(null).map((s,n)=>n+1);return W(t),t.slice(0,e)}function P(e=0){e==0&&(e=10+Math.floor(Math.random()*6));const t=q(e-2),s=new Array(e-2).fill(null).map((i,r)=>new Array(4).fill(t[r])).concat([[],[]]),n=new g(s);for(let i=0;i<70;i++){const r=new M(n.tubes,n.tubes.map(m=>m.topAmount)).randomItem(),h=n.tubes.filter(m=>!m.full&&m.id!==r.id),c=C(h),l=Math.min(r.singleColor?r.topAmount-1:r.topAmount,c.emptySpace),b=new M([1,2,3].splice(0,l),[1,3,9].splice(l)).randomItem(),v=r.levels.splice(-b);c.levels.push(...v)}let o=n.tubes.filter(i=>i.empty).length;for(let i=0;i<100&&o<2;i++){const r=n.tubes.filter(l=>!l.empty),h=C(r),c=n.tubes.filter(l=>!l.full&&l.levels.length>h.levels.length);if(c.length>0){const l=C(c),b=h.levels.splice(-1);l.levels.push(...b)}o=n.tubes.filter(l=>l.empty).length}return new g(n.tubes)}$(P());const j=2;function x(e,t){return e.possibleActions().filter(n=>e.tubes[n.from].singleColor&&e.tubes[n.to].empty?!1:n.from===(t==null?void 0:t.toIndex)&&n.to===(t==null?void 0:t.fromIndex)?(console.debug("filtered back move"),!1):!0)}class A{constructor(t,s,n){a(this,"state");a(this,"action");a(this,"unevaluatedActions");a(this,"parent");a(this,"children");a(this,"visits");a(this,"reward");this.state=t,this.action=n,this.unevaluatedActions=x(t,n),this.parent=s,this.children=[],this.visits=0,this.reward=0}get isTerminalNode(){return this.state.ended||this.unevaluatedActions.length===0&&this.children.length===0}get fullyExpanded(){return this.unevaluatedActions.length===0}bestChild(){let t=-1/0,s=null;for(const n of this.children){const o=n.getUpperConfidenceBound();o>t&&(s=n,t=o)}return s||console.error("invalid child"),s}getUpperConfidenceBound(){return this.visits===0?1/0:this.reward/this.visits+j*Math.sqrt(Math.log(this.parent.visits)/this.visits)}expand(){const t=this.unevaluatedActions.pop(),s=this.state.historyEntry(t),n=this.state.applyMove(t),o=new A(n,this,s);return this.children.push(o),o}backpropagate(t){this.visits++,this.reward+=t,this.parent&&this.parent.backpropagate(t)}}function z(e){const t=new A(e,null,null),s=10+e.tubes.length*4;let n=y.Playing,o=-1/0,i=[];const r=new Date().valueOf();let h=0,c=0;for(;c<1e3||n!==y.Won&&c<5e3;){const[l,b]=N(t),[v,m]=T(l.state,s),E=b.concat(m),w=_(v,E);console.debug(`run result ${w}`),l.backpropagate(w),w>o&&(i=E,o=w,n=v.status),h++,c=new Date().valueOf()-r}return console.info(`best result: ${n} with value ${o.toFixed(2)} after ${h} iterations (${c}ms)`),{result:n,actions:i}}function N(e){let t=e;const s=[];for(;!t.isTerminalNode;)if(t.fullyExpanded)t=t.bestChild(),s.push(t.action);else{t=t.expand(),s.push(t.action);break}return[t,s]}function O(e){return e[Math.floor(Math.random()*e.length)]}function T(e,t=20){const s=[];let n=e;for(let o=0;!n.ended&&o<t;o++){const i=x(n),r=O(i);s.push(n.historyEntry(r)),n=n.applyMove(r)}return[n,s]}function _(e,t){return e.won?50/t.length:e.lost?0:1*e.numClosed/e.tubes.length}onmessage=e=>{console.log("received message");const t=e.data.tubes.map(o=>new u(o.id,o.levels)),s=new g(t),n=z(s);postMessage(n)}})();
