(function(){"use strict";function m(s,t){if(s.empty)throw Error(`source-empty ${s.name}`);if(s.done)throw Error(`source-closed ${s.name}`);if(t.full)throw Error(`target-full ${s.name}`);const e=s.topColor;if(t.length>0&&e!==t.topColor)throw Error("invalid-color");const n=Math.min(s.topAmount,t.emptySpace),i=s.levels.slice(0,-n),o=Array(n).fill(e),h=[...t.levels,...o];return[new u(s.id,i),new u(t.id,h)]}class u{constructor(t,e=[]){this.id=t,this.levels=e}get name(){return String.fromCharCode(65+this.id)}get empty(){return this.levels.length===0}get full(){return this.levels.length>=4}get emptySpace(){return 4-this.levels.length}get done(){return this.levels.length===4&&this.levels[0]===this.levels[1]&&this.levels[1]===this.levels[2]&&this.levels[2]==this.levels[3]}get topColor(){return this.levels.length?this.levels[this.levels.length-1]:null}get topAmount(){if(this.levels.length<=1)return this.levels.length;const t=this.topColor;let e=1;for(;e<this.levels.length;){if(this.levels[this.levels.length-1-e]!=t)return e;e+=1}return this.levels.length}get singleColor(){return this.topAmount===this.levels.length}accepts(t){return this.empty?4:this.full?0:this.topColor===t?this.emptySpace:0}add(t){if(!this.full)return new u(this.id,[...this.levels,t])}}function p(){}function w(s,t){return s!=s?t==t:s!==t||s&&typeof s=="object"||typeof s=="function"}Promise.resolve();const a=[];function y(s,t=p){let e;const n=new Set;function i(l){if(w(s,l)&&(s=l,e)){const c=!a.length;for(const r of n)r[1](),a.push(r,s);if(c){for(let r=0;r<a.length;r+=2)a[r][0](a[r+1]);a.length=0}}}function o(l){i(l(s))}function h(l,c=p){const r=[l,c];return n.add(r),n.size===1&&(e=t(i)||p),l(s),()=>{n.delete(r),n.size===0&&(e(),e=null)}}return{set:i,update:o,subscribe:h}}function C(s){let t=[];for(let e=0;e<s.length;e++){const n=s[e];if(!n.done&&!n.empty)for(let i=0;i<s.length;i++){const o=s[i];e!==i&&o.accepts(n.topColor)&&t.push({from:n.id,to:o.id})}}return t}function A(s){return s.map(t=>t.done||t.empty).reduce((t,e)=>t&&e,!0)}class d{constructor(t=[]){this.tubes=[];for(const[e,n]of t.entries())n instanceof u?this.tubes.push(n):this.tubes.push(new u(e,n));A(this.tubes)?this.status="win":this.possibleActions().length===0&&(this.status="lose")}possibleActions(){return C(this.tubes)}get won(){return this.status==="win"}get lost(){return this.status==="lose"}get ended(){return this.status!==void 0}get numClosed(){return this.tubes.filter(t=>t.done).length}historyEntry({from:t,to:e}){if(this.tubes[t].topColor!==this.tubes[e].topColor&&!this.tubes[e].empty)throw new Error("invalid-color");const n=this.tubes[t].topColor;return{fromIndex:t,toIndex:e,fromId:this.tubes[t].name,toId:this.tubes[e].name,color:n,amount:Math.min(this.tubes[t].topAmount,this.tubes[e].accepts(n))}}applyMove({from:t,to:e}){const[n,i]=m(this.tubes[t],this.tubes[e]),o=[...this.tubes];return o[t]=n,o[e]=i,new d(o)}add(t,e){const n=[...this.tubes];return n[e]=this.tubes[e].add(t),new d(n)}getHash(){return this.tubes.map(t=>t.levels.concat(t.full?[]:[0])).flat().map(t=>t.toString(36)).join("")}}y([[9,8,5,2],[1,3,3,3],[6,5,8,5],[7,6,2,9],[9,6,8,7],[7,6,4,3],[2,1,8,5],[1,4,9,4],[1,7,2,4],[],[]].map((s,t)=>new u(t,s)));const M=2;function x(s,t){const e=s.tubes[t.from],n=s.tubes[t.to];return!!(e.singleColor&&n.empty)}class g{constructor(t,e,n){this.state=t,this.action=n,this.unevaluatedActions=t.possibleActions().filter(i=>!x(t,i)),this.parent=e,this.children=[],this.visits=0,this.reward=0}get isTerminalNode(){return this.state.ended||this.unevaluatedActions.length===0&&this.children.length===0}get fullyExpanded(){return this.unevaluatedActions.length===0}bestChild(){let t=-1/0,e=null;for(const n of this.children){const i=n.getUpperConfidenceBound();i>t&&(e=n,t=i)}return e||console.error("invalid child"),e}getUpperConfidenceBound(){return this.visits===0?1/0:this.reward/this.visits+M*Math.sqrt(Math.log(this.parent.visits)/this.visits)}expand(){const t=this.unevaluatedActions.pop(),e=this.state.historyEntry(t),n=this.state.applyMove(t),i=new g(n,this,e);return this.children.push(i),i}backpropagate(t){this.visits++,this.reward+=t,this.parent&&this.parent.backpropagate(t)}}function E(s){const t=new g(s,null),e=50;let n,i=-1/0,o=[];const h=new Date().valueOf();let l=0,c=0;for(;c<1e3||n!=="win"&&c<3e3;){const[r,R]=S(t),[b,k]=$(r.state,e),v=R.concat(k),f=I(b,v);console.debug(`run result ${f}`),r.backpropagate(f),f>i&&(o=v,i=f,n=b.status),l++,c=new Date().valueOf()-h}return console.info(`best result: ${n} with value ${i.toFixed(2)} after ${l} iterations (${c}ms)`),{result:n,actions:o}}function S(s){let t=s;const e=[];for(;!t.isTerminalNode;)if(t.fullyExpanded)t=t.bestChild(),e.push(t.action);else{t=t.expand(),e.push(t.action);break}return[t,e]}function T(s){return s[Math.floor(Math.random()*s.length)]}function $(s,t=20){const e=[];let n=s;for(let i=0;!n.ended&&i<t;i++){const o=n.possibleActions(),h=T(o);e.push(n.historyEntry(h)),n=n.applyMove(h)}return[n,e]}function I(s,t){return s.won?50/t.length:s.lost?0:1*s.numClosed/s.tubes.length}onmessage=s=>{console.log("received message");const t=s.data.tubes.map(i=>new u(i.id,i.levels)),e=new d(t),n=E(e);postMessage(n)}})();
