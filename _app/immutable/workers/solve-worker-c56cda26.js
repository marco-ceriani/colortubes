(function(){"use strict";function y(e,t){if(e.empty)throw Error(`source-empty ${e.name}`);if(e.done)throw Error(`source-closed ${e.name}`);if(t.full)throw Error(`target-full ${e.name}`);const s=e.topColor;if(t.length>0&&s!==t.topColor)throw Error("invalid-color");const n=Math.min(e.topAmount,t.emptySpace),o=e.levels.slice(0,-n),l=Array(n).fill(s),u=[...t.levels,...l];return[new h(e.id,o),new h(t.id,u)]}class h{constructor(t,s=[]){this.id=t,this.levels=s}get name(){return String.fromCharCode(65+this.id)}get empty(){return this.levels.length===0}get full(){return this.levels.length>=4}get emptySpace(){return 4-this.levels.length}get done(){return this.levels.length===4&&this.levels[0]===this.levels[1]&&this.levels[1]===this.levels[2]&&this.levels[2]==this.levels[3]}get topColor(){return this.levels.length?this.levels[this.levels.length-1]:null}get topAmount(){if(this.levels.length<=1)return this.levels.length;const t=this.topColor;let s=1;for(;s<this.levels.length;){if(this.levels[this.levels.length-1-s]!=t)return s;s+=1}return this.levels.length}get singleColor(){return this.topAmount===this.levels.length}accepts(t){return this.empty?4:this.full?0:this.topColor===t?this.emptySpace:0}add(t){if(!this.full)return new h(this.id,[...this.levels,t])}}function m(){}function C(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}Promise.resolve();const f=[];function A(e,t=m){let s;const n=new Set;function o(r){if(C(e,r)&&(e=r,s)){const c=!f.length;for(const i of n)i[1](),f.push(i,e);if(c){for(let i=0;i<f.length;i+=2)f[i][0](f[i+1]);f.length=0}}}function l(r){o(r(e))}function u(r,c=m){const i=[r,c];return n.add(i),n.size===1&&(s=t(o)||m),r(e),()=>{n.delete(i),n.size===0&&(s(),s=null)}}return{set:o,update:l,subscribe:u}}const M=19;function E(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if(!n.done&&!n.empty)for(let o=0;o<e.length;o++){const l=e[o];s!==o&&l.accepts(n.topColor)&&t.push({from:n.id,to:l.id})}}return t}function $(e){return e.map(t=>t.done||t.empty).reduce((t,s)=>t&&s,!0)}class d{constructor(t=[]){this.tubes=[];for(const[s,n]of t.entries())n instanceof h?this.tubes.push(n):this.tubes.push(new h(s,n));$(this.tubes)?this.status="win":this.possibleActions().length===0&&(this.status="lose")}possibleActions(){return E(this.tubes)}get won(){return this.status==="win"}get lost(){return this.status==="lose"}get ended(){return this.status!==void 0}get numClosed(){return this.tubes.filter(t=>t.done).length}historyEntry({from:t,to:s}){if(this.tubes[t].topColor!==this.tubes[s].topColor&&!this.tubes[s].empty)throw new Error("invalid-color");const n=this.tubes[t].topColor;return{fromIndex:t,toIndex:s,fromId:this.tubes[t].name,toId:this.tubes[s].name,color:n,amount:Math.min(this.tubes[t].topAmount,this.tubes[s].accepts(n))}}applyMove({from:t,to:s}){const[n,o]=y(this.tubes[t],this.tubes[s]),l=[...this.tubes];return l[t]=n,l[s]=o,new d(l)}add(t,s){const n=[...this.tubes];return n[s]=this.tubes[s].add(t),new d(n)}getHash(){return this.tubes.map(t=>t.levels.concat(t.full?[]:[0])).flat().map(t=>t.toString(36)).join("")}}function g(e){return e[Math.floor(Math.random()*e.length)]}function S(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}}function x(e){const t=Array(M).fill().map((s,n)=>n+1);return S(t),t.slice(0,e)}function I(e){e=e||10+Math.floor(Math.random()*6);const t=x(e-2),s=new Array(e-2).fill().map((l,u)=>new Array(4).fill(t[u])).concat([[],[]]),n=new d(s);for(let l=0;l<70;l++){const u=n.tubes.filter(a=>!a.empty),r=g(u),c=n.tubes.filter(a=>!a.full&&a.id!==r.id),i=g(c);console.debug(`move ${l}: ${r.id} -> ${i.id}`);const p=r.levels.splice(-1);i.levels.push(...p)}let o=n.tubes.filter(l=>l.empty).length;for(let l=0;l<100&&o<2;l++){const u=n.tubes.filter(i=>!i.empty),r=g(u),c=n.tubes.filter(i=>!i.full&&i.levels.length>r.levels.length);if(c.length>0){const i=g(c);console.debug(`move: ${r.id} -> ${i.id}`);const p=r.levels.splice(-1);i.levels.push(...p)}o=n.tubes.filter(i=>i.empty).length}return new d(n.tubes)}A(I());const R=2;function T(e,t){const s=e.tubes[t.from],n=e.tubes[t.to];return!!(s.singleColor&&n.empty)}class v{constructor(t,s,n){this.state=t,this.action=n,this.unevaluatedActions=t.possibleActions().filter(o=>!T(t,o)),this.parent=s,this.children=[],this.visits=0,this.reward=0}get isTerminalNode(){return this.state.ended||this.unevaluatedActions.length===0&&this.children.length===0}get fullyExpanded(){return this.unevaluatedActions.length===0}bestChild(){let t=-1/0,s=null;for(const n of this.children){const o=n.getUpperConfidenceBound();o>t&&(s=n,t=o)}return s||console.error("invalid child"),s}getUpperConfidenceBound(){return this.visits===0?1/0:this.reward/this.visits+R*Math.sqrt(Math.log(this.parent.visits)/this.visits)}expand(){const t=this.unevaluatedActions.pop(),s=this.state.historyEntry(t),n=this.state.applyMove(t),o=new v(n,this,s);return this.children.push(o),o}backpropagate(t){this.visits++,this.reward+=t,this.parent&&this.parent.backpropagate(t)}}function k(e){const t=new v(e,null),s=50;let n,o=-1/0,l=[];const u=new Date().valueOf();let r=0,c=0;for(;c<1e3||n!=="win"&&c<3e3;){const[i,p]=q(t),[a,_]=N(i.state,s),w=p.concat(_),b=O(a,w);console.debug(`run result ${b}`),i.backpropagate(b),b>o&&(l=w,o=b,n=a.status),r++,c=new Date().valueOf()-u}return console.info(`best result: ${n} with value ${o.toFixed(2)} after ${r} iterations (${c}ms)`),{result:n,actions:l}}function q(e){let t=e;const s=[];for(;!t.isTerminalNode;)if(t.fullyExpanded)t=t.bestChild(),s.push(t.action);else{t=t.expand(),s.push(t.action);break}return[t,s]}function j(e){return e[Math.floor(Math.random()*e.length)]}function N(e,t=20){const s=[];let n=e;for(let o=0;!n.ended&&o<t;o++){const l=n.possibleActions(),u=j(l);s.push(n.historyEntry(u)),n=n.applyMove(u)}return[n,s]}function O(e,t){return e.won?50/t.length:e.lost?0:1*e.numClosed/e.tubes.length}onmessage=e=>{console.log("received message");const t=e.data.tubes.map(o=>new h(o.id,o.levels)),s=new d(t),n=k(s);postMessage(n)}})();
